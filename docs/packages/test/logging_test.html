<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>logging_test.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>logging_test.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Copyright 2020 Red Hat, Inc</p>
<p>Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
Submodule for testing ccx_data_pipeline.logging.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">ccx_data_pipeline.logging</span> <span class="kn">import</span> <span class="n">setup_watchtower</span>


<span class="n">_INCOMPLETE_CW_CONFIGURATION</span> <span class="o">=</span> <span class="p">[</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Missing one env var</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
    <span class="p">},</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>All envs, but some empty</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{},</span>
<span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Test that no watchtower is used when environment is not configured.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;fake_env&quot;</span><span class="p">,</span> <span class="n">_INCOMPLETE_CW_CONFIGURATION</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.Session&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.CloudWatchLogHandler&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.logging.getLogger&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_setup_watchtower_misconfigured</span><span class="p">(</span><span class="n">get_logger_mock</span><span class="p">,</span> <span class="n">fake_env</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.os.environ&quot;</span><span class="p">,</span> <span class="n">fake_env</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">setup_watchtower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">get_logger_mock</span><span class="o">.</span><span class="n">called</span> <span class="ow">is</span> <span class="kc">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Test logger configuration. Mocking everything to avoid network failures.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.Session&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.CloudWatchLogHandler&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.logging.getLogger&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_setup_watchtower</span><span class="p">(</span><span class="n">get_logger_mock</span><span class="p">,</span> <span class="n">log_handler_init_mock</span><span class="p">,</span> <span class="n">session_init_mock</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>logging.getLogger return a mocked log</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logger_mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">get_logger_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">logger_mock</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Session init should return a mock to check CloudWatchLogHandler args</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">session_mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">session_init_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">session_mock</span>

    <span class="n">valid_env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_KEY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS_SECRET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;a region&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;a group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;the stream&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOGGING_TO_CW_ENABLED&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s2">&quot;ccx_data_pipeline.logging.os.environ&quot;</span><span class="p">,</span> <span class="n">valid_env</span><span class="p">):</span>
        <span class="n">setup_watchtower</span><span class="p">()</span>
        <span class="n">session_init_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">valid_env</span><span class="p">[</span><span class="s2">&quot;CW_AWS_ACCESS_KEY_ID&quot;</span><span class="p">],</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">valid_env</span><span class="p">[</span><span class="s2">&quot;CW_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">],</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">valid_env</span><span class="p">[</span><span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">log_handler_init_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="n">boto3_session</span><span class="o">=</span><span class="n">session_mock</span><span class="p">,</span>
            <span class="n">log_group</span><span class="o">=</span><span class="n">valid_env</span><span class="p">[</span><span class="s2">&quot;CW_LOG_GROUP&quot;</span><span class="p">],</span>
            <span class="n">stream_name</span><span class="o">=</span><span class="n">valid_env</span><span class="p">[</span><span class="s2">&quot;CW_STREAM_NAME&quot;</span><span class="p">],</span>
            <span class="n">create_log_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
